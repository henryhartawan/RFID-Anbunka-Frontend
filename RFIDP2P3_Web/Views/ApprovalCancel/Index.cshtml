@{
    ViewData["Title"] = "Approval Cancel";
    string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<div class="page-main">
    <div class="page-content padding-5">
        <div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
    </div>
</div>

<script>
    var AppD = {
        attachEvents: function () {
            var o = this;

            o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
            o.dom.$grid.on('click', '#btnSearch', o.eventHandlers.onClickBtnSearch.bind(o));

            o.dom.$grid.on('click', '.btnApprove', o.eventHandlers.onClickBtnApprove.bind(o));
            o.dom.$grid.on('click', '.btnReject', o.eventHandlers.onClickBtnReject.bind(o));
        },
        cacheDom: function () {
            var o = this;
            o.dom.$grid = $("#grid");
        },
        data: {
            From: kendo.toString((function () { var a = new Date(); a.setDate(a.getDate() - 7); return a })(), 'yyyy-MM-dd'),
            To: kendo.toString((function () { var a = new Date(); a.setDate(a.getDate()); return a })(), 'yyyy-MM-dd')
        },
        dom: {},
        eventHandlers: {
            onClickBtnSearch: function (e) {
                var o = this;
                o.dom.$grid.data('kendoGrid').dataSource.read();
            },
            onClickBtnApprove: function (e) {
                var o = this;
                var di = o.dom.$grid.data('kendoGrid').dataItem($(e.target).closest('tr'));

                swal.fire({
                    title: "Approve?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            method: 'post',
                            headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                            url: "@myurl" + 'ApprovalCancel/App',
                            dataType: 'text',
                            data: JSON.stringify({
                                ID: di.ID,
                                ScanType: di.ScanType,
                                RFIDNo: di.RFIDNo,
                                Approval: 'A',
                                UserLogin: "@Context.Session.GetString("PIC_ID")",
                                Reason: di.Reason
                            })
                        }).done(function (data, textStatus, jqXHR) {
                            if (data !== 'success') {
                                swal.fire('Error', data, 'error');
                                return;
                            }
                            swal.fire({ title: 'Success', text: 'Data saved', icon: 'success', timer: 2000, showConfirmButton: false });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
                        }).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
                            o.dom.$grid.data('kendoGrid').dataSource.read();
                        });
                    }
                });
            },
            onClickBtnReject: function (e) {
                var o = this;
                var di = o.dom.$grid.data('kendoGrid').dataItem($(e.target).closest('tr'));

                swal.fire({
                    title: "Reject?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            method: 'post',
                            headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                            url: "@myurl" + 'ApprovalCancel/App',
                            dataType: 'text',
                            data: JSON.stringify({
                                ID: di.ID,
                                ScanType: di.ScanType,
                                RFIDNo: di.RFIDNo,
                                ScanType: di.ScanType,
                                Approval: 'R',
                                UserLogin: "@Context.Session.GetString("PIC_ID")",
                                Reason: di.Reason
                            })
                        }).done(function (data, textStatus, jqXHR) {
                            if (data !== 'success') {
                                swal.fire('Error', data, 'error');
                                return;
                            }
                            swal.fire({ title: 'Success', text: 'Data saved', icon: 'success', timer: 2000, showConfirmButton: false });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
                        }).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
                            o.dom.$grid.data('kendoGrid').dataSource.read();
                        });
                    }
                });
            },
            onClickBtnExcel: function () {
                var o = this;
                o.dom.$grid.data('kendoGrid').saveAsExcel();
            }
        },
        init: function () {
            var o = this;
            o.cacheDom();
            o.attachEvents();
            o.initElements();
        },
        initElements: function () {
            var o = this;

            o.dom.$grid.kendoGrid({
                dataSource: {
                    transport: {
                        read: function (options) {
                            $.ajax({
                                method: 'post',
                                headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                                url: "@myurl" + 'ApprovalCancel/INQ',
                                dataType: 'text',
                                data: JSON.stringify({
                                    From: o.data.From,
                                    To: o.data.To
                                })
                            }).done(function (data, textStatus, jqXHR) {
                                try {
                                    var result = JSON.parse(data);
                                }
                                catch (e) {
                                    swal.fire('Error', 'Error loading grid', 'error');
                                    options.success({ data: [] });
                                    return;
                                }
                                options.success(result);
                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
                                options.success({ data: [] });
                            });
                        }
                    },
                    schema: {
                        model: {
                            id: "ID",
                            fields: {
                                ID: { type: "string" },
                                ScanType: { type: "string" },
                                SAP_Doc_No: { type: "string" },
                                LDK_No: { type: "string" },
                                RFIDNo: { type: "string" },
                                PalletTypeName: { type: "string" },
                                PartNumber: { type: "string" },
                                PartDescription: { type: "string" },
                                KanbanNumber: { type: "string" },
                                ProcessArea: { type: "string" },
                                ProcessDate: { type: "string" },
                                UserProposed: { type: "string" },
                                DateProposed: { type: "string" },
                                Reason: { type: "string" },
                                CancelStatus: { type: "string" },
                                UserApprove: { type: "string" },
                                CancelDate: { type: "string" },
                                SAP_Cancel_Doc_No: { type: "string" },
                                BuildingName: { type: "string" },
                                PlantId: { type: "string" }
                            }
                        }
                    },
                    pageSize: 20
                },
                scrollable: true,
                sortable: true,
                resizable: true,
                reorderable: true,
                filterable: {
                    extra: false,
                    operators: {
                        string: {
                            contains: "Contains",
                            eq: "Equal to",
                            neq: "Not equal to"
                        }
                    }
                },
                pageable: {
                    refresh: true,
                    input: true,
                    numeric: true,
                    pageSizes: true,
                    buttonCount: 5
                },
                columns: [
                @if (Context.Session.GetString("edit_ApprovalCancel") == "True")
                {
                    <text>
                    {
                        title: "Approve",
                        width: 50,
                        command: [{
                            name: "Approve",
                            text: "<i class='fa fa-thumbs-o-up btnApprove' style='font-size:18px;color:green;'></i>"
                        }]
                    },
                    {
                        title: "Reject",
                        width: 50,
                        command: [{
                            name: "Reject",
                            text: "<i class='fa fa-thumbs-o-down btnReject' style='font-size:18px;color:red;'></i>"
                        }]
                    },
                    </text>
                }
                {
                    title: "Plant",
                    field: "PlantId",
                    template: "<div class='customClass'> #= (PlantId == null) ? ' ' : kendo.toString(PlantId, '') # </div>",
                    width: 80
                },
                {
                    title: "Gedung",
                    field: "BuildingName",
                    template: "<div class='customClass'> #= (BuildingName == null) ? ' ' : kendo.toString(BuildingName, '') # </div>",
                    width: 100
                },
                {
                    title: "Doc No. SAP",
                    field: "SAP_Doc_No",
                    template: "<div class='customClass'> #= (SAP_Doc_No == null) ? ' ' : kendo.toString(SAP_Doc_No, '') # </div>",
                    width: 100
                },
                {
                    title: "No. LDK",
                    field: "LDK_No",
                    template: function (dataItem) {
                        var str = dataItem.LDK_No;
                        var res = str.replace(/\;/g, '<br/>');
                        return res;
                    },
                    width: 150
                },
                {
                    title: "RFID No.",
                    field: "RFIDNo",
                    template: "<div class='customClass'> #= (RFIDNo == null) ? ' ' : kendo.toString(RFIDNo, '') # </div>",
                    width: 150
                },
                {
                    title: "RFID Type",
                    field: "PalletTypeName",
                    template: "<div class='customClass'> #= (PalletTypeName == null) ? ' ' : kendo.toString(PalletTypeName, '') # </div>",
                    width: 150
                },
                {
                    title: "Material No",
                    field: "PartNumber",
                    template: "<div class='customClass'> #= (PartNumber == null) ? ' ' : kendo.toString(PartNumber, '') # </div>",
                    width: 100
                },
                {
                    title: "Material Desc.",
                    field: "PartDescription",
                    template: "<div class='customClass'> #= (PartDescription == null) ? ' ' : kendo.toString(PartDescription, '') # </div>",
                    width: 200
                },
                {
                    title: "Kanban No.",
                    field: "KanbanNumber",
                    width: 250,
                    template: "<div class='customClass'> #= (KanbanNumber == null) ? ' ' : kendo.toString(KanbanNumber, '') # </div>",
                },
                {
                    title: "Area Process",
                    field: "ProcessArea",
                    template: "<div class='customClass'> #= (ProcessArea == null) ? ' ' : kendo.toString(ProcessArea, '') # </div>",
                    width: 100
                },
                {
                    title: "Process Date",
                    field: "ProcessDate",
                    template: "<div class='customClass'> #= (ProcessDate == null) ? ' ' : kendo.toString(ProcessDate, '') # </div>",
                    width: 100
                },
                {
                    title: "User Proposed",
                    field: "UserProposed",
                    template: "<div class='customClass'> #= (UserProposed == null) ? ' ' : kendo.toString(UserProposed, '') # </div>",
                    width: 100
                },
                {
                    title: "Proposed Date",
                    field: "DateProposed",
                    template: "<div class='customClass'> #= (DateProposed == null) ? ' ' : kendo.toString(DateProposed, '') # </div>",
                    width: 100
                },
                {
                    title: "Reason/Note",
                    field: "Reason",
                    template: "<div class='customClass'> #= (Reason == null) ? ' ' : kendo.toString(Reason, '') # </div>",
                    width: 100
                },
                {
                    title: "Cancel Status",
                    field: "CancelStatus",
                    template: "<div class='customClass'> #= (CancelStatus == null) ? ' ' : kendo.toString(CancelStatus, '') # </div>",
                    width: 100
                },
                {
                    title: "User Approve",
                    field: "UserApprove",
                    template: "<div class='customClass'> #= (UserApprove == null) ? ' ' : kendo.toString(UserApprove, '') # </div>",
                    width: 100
                },
                {
                    title: "Cancel Date",
                    field: "CancelDate",
                    template: "<div class='customClass'> #= (CancelDate == null) ? ' ' : kendo.toString(CancelDate, '') # </div>",
                    width: 100
                },
                {
                    title: "Cancel Doc No SAP",
                    field: "SAP_Cancel_Doc_No",
                    template: "<div class='customClass'> #= (SAP_Cancel_Doc_No == null) ? ' ' : kendo.toString(SAP_Cancel_Doc_No, '') # </div>",
                    width: 100
                }],
                toolbar: $("#template_toolbar").html(),
                dataBound: function () {
                    o.initAfter();

                    var grid = this;
                    grid.tbody.find("tr[role='row']").each(function () {
                        var model = grid.dataItem(this);
                        if (model.CancelStatus != 'Waiting') {
                            $(this).find(".k-grid-Approve").hide();
                            $(this).find(".k-grid-Reject").hide();
                        } else {
                            $(this).find(".k-grid-Approve").show();
                            $(this).find(".k-grid-Reject").show();
                        }
                    });
                }
            });
        },
        initAfter: function () {
            var o = this;
            if (o.initAfterCalled) return;
            o.initAfterCalled = true;

            o.dom.From = $("#From");
            o.dom.To = $("#To");

            o.dom.From.kendoDatePicker({
                format: 'dd MMM yyyy',
                value: o.data.From,
                max: o.data.To,
                change: function () {
                    o.data.From = this.value() != null ? kendo.toString(this.value(), 'yyyy-MM-dd') : '';
                    if (this.value() != null) o.dom.To.data('kendoDatePicker').min(o.data.From);
                }
            });

            o.dom.To.kendoDatePicker({
                format: 'dd MMM yyyy',
                min: o.data.From,
                value: o.data.To,
                change: function () {
                    o.data.To = this.value() != null ? kendo.toString(this.value(), 'yyyy-MM-dd') : '';
                    if (this.value() != null) o.dom.From.data('kendoDatePicker').max(o.data.From);
                }
            });
        }
    };

    $(function () {
        AppD.init();
    });
</script>

<script type="text/x-kendo-template" id="template_toolbar">
    <span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- Approval Cancel -&nbsp;&nbsp;</span>
    <div class="toolbar">
        <button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
            <i class="k-icon k-i-excel"></i>
        </button>
        &nbsp;&nbsp;
        <input type="date" id="From" placeholder="Period From" />&nbsp;
        <input type="date" id="To" placeholder="Period To" />&nbsp;
        <button data-toggle="tooltip" title="Search" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnSearch">
            <i class="fa fa-search"></i>
        </button>
    </div>
</script>