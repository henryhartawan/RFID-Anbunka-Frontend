@{
    ViewData["Title"] = "GR Production";
	string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<div class="page-main">
    <div class="page-content padding-5">
        <div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
    </div>
</div>

<div class="modal fade modal-primary" id="editorUpload" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="padding-top:25vh;">
    <div class="" role="document" style="padding-left:25vw;">
        <div class="modal-content" style="width:50vw">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalTitle">Upload GR Pro</h4>
            </div>
            <div class="modal-body margin-bottom-0 padding-bottom-0">
                <form id="formUpload" enctype="multipart/form-data">
                    <span>Download template <a href="../../templates/GR Pro.xlsx" style="color:#0099ff" download="Template GR Pro.xlsx">here</a></span>
                    <input type="file" name="file" class="form-control" id="fileUpload" accept=".xls,.xlsx" />
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id='clear'>Close</button>
                <button type="button" class="btn btn-primary" id="btnSaveUpload" value="Upload">Upload</button>
            </div>
        </div>
    </div>
</div>

<script>
    var AppD = {
        attachEvents: function () {
            var o = this;
            o.dom.$btnSaveUpload.on('click', o.eventHandlers.onClickBtnSaveUpload.bind(o));

            o.dom.$grid.on('input', '#GRPro', o.eventHandlers.onChange.bind(o));
            o.dom.$grid.on('click', '#GRPro', o.eventHandlers.onClickFocus.bind(o));

            o.dom.$grid.on('click', '#btnUpload', o.eventHandlers.onClickBtnUpload.bind(o));
            o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
            o.dom.$grid.on('click', '#btnSearch', o.eventHandlers.onClickBtnSearch.bind(o));

            o.dom.$grid.on('click', '.btnResync', o.eventHandlers.onClickBtnResync.bind(o));
        },
        cacheDom: function () {
            var o = this;
            o.dom.$grid = $("#grid");
            o.dom.$editorUpload = $("#editorUpload");
            o.dom.$btnSaveUpload = $("#btnSaveUpload");
        },
        data: {
            GRPro:'',
            PostingDate:''
        },
        dom: {},
        eventHandlers: {
            onClickBtnUpload: function () {
                var o = this;
                $("#fileUpload").data('kendoUpload').clearAllFiles();
                o.dom.$editorUpload.modal('show');
            },
            onClickBtnSaveUpload: function () {
                var o = this;
                swal.fire({
                    title: 'Upload GR Pro?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes'
                }).then((result) => {
                    if (result.isConfirmed) {
                        let formData = new FormData();
                        let files = $("#fileUpload").data('kendoUpload').getFiles();
                        let file = files[0].rawFile;
                        formData.append('file', file);

                        $.ajax({
                            url: "@myurl" + "GRPro/Upload?UID=" + "@Context.Session.GetString("PIC_ID")",
                            headers: { 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                            type: 'post',
                            data: formData,
                            contentType: false,
                            processData: false
                        }).done(function () {
                            o.dom.$editorUpload.modal('hide');
                            swal.fire({ title: 'Success', text: 'Data Uploaded', icon: 'success', timer: 2000, showConfirmButton: false });
                            $("#fileUpload").data('kendoUpload').clearAllFiles();
                        }).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
                            $("#grid").data('kendoGrid').dataSource.read();
                            $("#fileUpload").data('kendoUpload').clearAllFiles();
                        });
                    }
                });
            },
			onClickBtnSearch: function (e) {
                var o = this;
                o.dom.$grid.data('kendoGrid').dataSource.read();
			},
            onClickBtnExcel: function () {
                var o = this;
                o.dom.$grid.data('kendoGrid').saveAsExcel();
            },
            onChange: function () {
                var o = this;
                o.data.GRPro = $("#GRPro").val();
            },
            onClickFocus(e){ $(e.target).select(); },
            onClickBtnResync: function (e) {
                var o = this;
                var di = o.dom.$grid.data('kendoGrid').dataItem($(e.target).closest('tr'));

                var pattern = /(\d{2})\/(\d{2})\/(\d{4})/;
                var dt = new Date(di.PostingDate.replace(pattern, '$3-$2-$1'));

                swal.fire({
                    title: 'Resync?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes'
                }).then((result) => { 
                    if (result.isConfirmed) {
                        $.ajax({
                            method: 'post',
                            headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                            url: "@myurl" + 'GRPro/Resync',
                            dataType: 'text',
                            data: JSON.stringify({
                                GRProNo: di.GRProNo,
                                PartNumber: di.PartNumber,
                                PostingDate: kendo.toString(dt, 'yyyy-MM-dd'),
                                UserLogin: "@Context.Session.GetString("PIC_ID")",
                            })
                        }).done(function (data, textStatus, jqXHR) {
                            if (data !== 'success') {
                                swal.fire('', data, 'error');
                                console.log(jqXHR);
                                return;
                            }
                            swal.fire({ title: 'Success', text: 'Data deleted', icon: 'success', timer: 2000, showConfirmButton: false });
                        }).fail(function (jqXHR, textStatus, errorThrown) {
                            swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
                            console.log(jqXHR);
                        }).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
                            o.dom.$grid.data('kendoGrid').dataSource.read();
                        });
                    }
                });
            }
        },
        init: function () {
            var o = this;
            o.cacheDom();
            o.attachEvents();
            o.initElements();
        },
        initElements: function () {
            var o = this;

            o.dom.$grid.kendoGrid({
                excel: {
                    fileName: "GR Production.xlsx",
                    allPages: true,
                    filterable: true
                },
                dataSource: {
                    transport: {
                        read: function (options) {
                            $.ajax({
                                method: 'post',
                                headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
                                url: "@myurl"+'GRPro/INQ',
                                dataType: 'text',
                                data: JSON.stringify({
                                    GRProNo: o.data.GRPro,
                                    PostingDate: o.data.PostingDate
                                })
                            }).done(function (data, textStatus, jqXHR) {
                                try {
                                    var result = JSON.parse(data);
                                }
                                catch (e) {
                                    swal.fire('Error', 'Error loading grid', 'error');
                                    options.success({ data: [] });
                                    return;
                                }
                                options.success(result);
                            }).fail(function (jqXHR, textStatus, errorThrown) {
                                swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
                                options.success({ data: [] });
                            });
                        }
                    },
                    schema: {
                        model: {
                            id: "GRProNo",
                            fields: {
                                PartNumber: { type: "string" },
                                PartDesc: { type: "string" },
                                PartName: { type: "string" },
                                PartQty: { type: "string" },
                                PostingDate: { type: "string" },
                                GRProNo: { type: "string" },
                                SAPStatus: { type: "string" },
                                SAPOutFile: { type: "string" },
                                SAPInFile: { type: "string" },
                                SAPGRMatDocNo: { type: "string" },
                                ErrorMessage: { type: "string" }
                            }
                        }
                    },
                    pageSize: 20
                },
                scrollable: true,
                sortable: true,
                resizable: true,
                reorderable: true,
                filterable: {
                    extra: false,
                    operators: {
                        string: {
                            contains: "Contains",
                            eq: "Equal to",
                            neq: "Not equal to"
                        }
                    }
                },
                pageable: {
                    refresh: true,
                    input: true,
                    numeric: true,
                    pageSizes: true,
                    buttonCount: 5
                },
                columns: [
                @if (Context.Session.GetString("edit_GRPro") == "True")
                {
                    <text>
                    {
                        title: "Resync",
                        width: 50,
                        command: [{
                            name: "Resync",
                            text: "<i class='fa fa-refresh btnResync' style='font-size:18px;color:#0000ff;'></i>"
                        }]
                    },
                    </text>
                }
                {
                    title: "Part",
                    columns: [
                    {
                        field: "PartNumber",
                        title: "No",
                        width: 100
                    },
                    {
                        field: "PartDesc",
                        title: "Desc",
                        width: 150,
                        template: "<div class='customClass'> #= (PartDesc == null) ? ' ' : kendo.toString(PartDesc, '') # </div>",
                    },
                    {
                        field: "PartName",
                        title: "Name",
                        width: 150
                    }]
                },
                {
                    field: "PartQty",
                    title: "Qty",
                    width: 100
                },
                {
                    field: "PostingDate",
                    title: "Posting Date",
                    template: "<div class='customClass'> #= (PostingDate == null) ? ' ' : PostingDate.substring(0,10) # </div>",
                    width: 100
                },
                {
                    field: "GRProNo",
                    title: "No. Pro",
                    width: 100
                },
                {
                    field: "SAPStatus",
                    title: "Status SAP",
                    width: 80
                },
                {
                    field: "SAPGRMatDocNo",
                    title: "MatDoc",
                    width: 100,
                },
                {
                    field: "SAPInFile",
                    title: "SAP In",
                    width: 250,
                    template: "<div class='customClass'> #= (SAPInFile == null) ? ' ' : kendo.toString(SAPInFile, '') # </div>",
                },
                {
                    field: "SAPOutFile",
                    title: "SAP Out",
                    width: 250,
                    template: "<div class='customClass'> #= (SAPOutFile == null) ? ' ' : kendo.toString(SAPOutFile, '') # </div>",
                },
                {
                    field: "ErrorMessage",
                    title: "Error Message",
                    width: 200,
                    template: "<div class='customClass'> #= (ErrorMessage == null) ? ' ' : kendo.toString(ErrorMessage, '') # </div>",
                }],
                toolbar: $("#template_toolbar").html(),
                dataBound: function () {
                    o.initAfter();

                    var grid = this;
                    grid.tbody.find("tr[role='row']").each(function () {
                        var model = grid.dataItem(this);
                        if (model.SAPStatus == 'Success' || model.SAPStatus == 'Waiting') {
                            $(this).find(".k-grid-Resync").hide();
                        } else {
                            $(this).find(".k-grid-Resync").show();
                        }
                    });
                }
            });

            $("#fileUpload").kendoUpload({
                multiple: false,
                validation: {
                    allowedExtensions: [".xls", "xlsx"]
                }
            });
        },
        initAfter: function () {
            var o = this;
            if (o.initAfterCalled) return;
            o.initAfterCalled = true;

            o.dom.PostingDate = $("#PostingDate");

            o.dom.PostingDate.kendoDatePicker({
                format: 'dd MMM yyyy',
                change: function () {
                    o.data.PostingDate = kendo.toString(this.value(), 'yyyy-MM-dd');
                }
            });
        }
    };

    $(function () {
        AppD.init();
    });

</script>

<script type="text/x-kendo-template" id="template_toolbar">
    <span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- GR Production -&nbsp;&nbsp;</span>
    <div class="toolbar">
    @if (Context.Session.GetString("add_GRPro") == "True")
    {
        <button data-toggle="tooltip" title="Upload" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnUpload">
            <i class="k-icon k-i-upload"></i>
        </button>
    }
        <button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
            <i class="k-icon k-i-excel"></i>
        </button>
        &nbsp;&nbsp;
        <input class="k-input" type="text" id="GRPro" placeholder="Production No." style='width:200px;text-align:center;' />&nbsp;
        <input type="date" id="PostingDate" placeholder="Posting Date" />&nbsp;
        <button data-toggle="tooltip" title="Search" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnSearch">
            <i class="fa fa-search"></i>
        </button>
    </div>
</script>