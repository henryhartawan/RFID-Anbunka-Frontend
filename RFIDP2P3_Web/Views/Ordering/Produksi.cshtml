@{
	ViewData["Title"] = "Produksi";
	string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<style>
	.k-grid-header th .k-link {
		white-space: normal !important;
		word-wrap: break-word;
	}

	.k-grid-header th {
		vertical-align: top !important;
	}
</style>

<div class="page-main">
	<div class="page-content padding-10">
		<button type="button" id="btnLoad" class="btn btn-primary" style="display:none;">Load</button>
		<div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
	</div>
</div>

<script>
	var AppD = {
		attachEvents: function () {
			var o = this;
			o.dom.$btnLoad.on('click', o.eventHandlers.onClickBtnLoad.bind(o));
			o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
		},
		cacheDom: function () {
			var o = this;
			o.dom.$grid = $("#grid");
			o.dom.$btnLoad = $("#btnLoad");
		},
		data: {
			Type: 'PL',
			Prod_Date: new Date(),
			Line: '',
			UN: ''
		},
		dom: {},
		eventHandlers: {
			onClickBtnExcel: function () {
				var o = this;
				o.dom.$grid.data('kendoGrid').saveAsExcel();
			},
			onClickBtnLoad: function(){
				var o = this;

				$.ajax({
					method: 'post',
					headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
					url: "@myurl"+'Produksi/INQ',
					dataType: 'text',
					data: JSON.stringify({
						Type: o.data.Type,
						Prod_Date: kendo.toString(o.data.Prod_Date, 'yyyyMMdd'),
						Line: o.data.Line,
						UniqueNumber: o.data.UN
					})
				}).done(function (data, textStatus, jqXHR) {
					try {
						var result = JSON.parse(data);
					}
					catch (e) {
						swal.fire('Error', 'Error loading grid', 'error');
						options.success({ data: [] });
						return;
					}

					var schemaFields = {
						LineOrderCode: {type: "string"},
						CPLID: {type: "string"},
						ExCore: {type: "string"},
						UniqueLineID: {type: "string"},
						QtyPerUnit: {type: "string"},
						RatioGrade: {type: "number"},
						DepthID: {type: "string"},
						Unique_No: {type: "string"},
						Groups: {type: "string"},
						SupplierName: {type: "string"},
						JobNo: {type: "string"}
					};

					var columns =
					[
						{
							field: "Groups",
							title: "Groups",
							width: 80,
							filterable: {
								multi:true,
								search: true
							},
						},
						{
							field: "LineOrderCode",
							title: "Line",
							width: 70,
						},
						{
							field: "CPLID",
							title: "CPL",
							width: 70	
						},
						{
							field: "ExCore",
							title: "Ex Core",
							width: 100,
							template: "<div class='customClass'> #= (ExCore == null) ? ' ' : kendo.toString(ExCore, '') # </div>",
						},
						{
							field: "UniqueLineID",
							title: "Unique Line",
							width: 80,
							template: "<div class='customClass'> #= (UniqueLineID == null) ? ' ' : kendo.toString(UniqueLineID, '') # </div>",
						},
						{
							field: "QtyPerUnit",
							title: "Qty per Unit",
							width: 80,
						},
						{
							field: "RatioGrade",
							title: "Ratio (%)",
							width: 70,
							template: "<div class='customClass'> #= (RatioGrade == null) ? ' ' : kendo.toString(RatioGrade, '0.00') # </div>",
						},
						{
							field: "DepthID",
							title: "Depth",
							width: 100,
						},
						{
							field: "Unique_No",
							title: "UN",
							width: 70,
							template: "<div class='customClass'> #= (Unique_No == null) ? ' ' : kendo.toString(Unique_No, '') # </div>",
						},
						{
							field: "SupplierName",
							title: "Supplier",
							width: 150,
							template: "<div class='customClass'> #= (SupplierName == null) ? ' ' : kendo.toString(SupplierName, '') # </div>",
						},
						{
							field: "JobNo",
							title: "Job No",
							width: 70,
							template: "<div class='customClass'> #= (JobNo == null) ? ' ' : kendo.toString(JobNo, '') # </div>",
						},
					];

					var column = null;
					for(var key in result[0]){
						if(result[0].hasOwnProperty(key)){
							if(['LineOrderCode'].indexOf(key) >= 0){
								continue;
							}
							if(['CPLID'].indexOf(key) >= 0){
								continue;
							}
							if(['ExCore'].indexOf(key) >= 0){
								continue;
							}
							if(['UniqueLineID'].indexOf(key) >= 0){
								continue;
							}
							if(['RatioGrade'].indexOf(key) >= 0){
								continue;
							}
							if(['QtyPerUnit'].indexOf(key) >= 0){
								continue;
							}
							if(['CPLStatus'].indexOf(key) >= 0){
								continue;
							}
							if(['DepthID'].indexOf(key) >= 0){
								continue;
							}
							if(['Depth'].indexOf(key) >= 0){
								continue;
							}
							if(['NewDepth'].indexOf(key) >= 0){
								continue;
							}
							if(['Index_From'].indexOf(key) >= 0){
								continue;
							}
							if(['Index_To'].indexOf(key) >= 0){
								continue;
							}
							if(['Unique_No'].indexOf(key) >= 0){
								continue;
							}
							if(['ID_PL'].indexOf(key) >= 0){
								continue;
							}
							if(['Qty_PL'].indexOf(key) >= 0){
								continue;
							}
							if(['Total_Qty_PL'].indexOf(key) >= 0){
								continue;
							}
							if(['ColTOT'].indexOf(key) >= 0){
								continue;
							}
							if(['Total_Qty'].indexOf(key) >= 0){
								continue;
							}
							if(['Groups'].indexOf(key) >= 0){
								continue;
							}
							if(['CycleIssueX'].indexOf(key) >= 0){
								continue;
							}
							if(['CycleIssueY'].indexOf(key) >= 0){
								continue;
							}
							if(['CycleIssueZ'].indexOf(key) >= 0){
								continue;
							}
							if(['Periode_ID'].indexOf(key) >= 0){
								continue;
							}
							if(['ProdDay'].indexOf(key) >= 0){
								continue;
							}
							if(['Prod_Date'].indexOf(key) >= 0){
								continue;
							}
							if(['ID_NPL'].indexOf(key) >= 0){
								continue;
							}
							if(['Shift_Code'].indexOf(key) >= 0){
								continue;
							}
							if(['SupplierName'].indexOf(key) >= 0){
								continue;
							}
							if(['JobNo'].indexOf(key) >= 0){
								continue;
							}

							var tgl = key.substring(7,9) + '/' + key.substring(5,7) + '/' + key.substring(1,5);

							if(column != null && column.title != tgl){
								columns.push(column);
								column = null;
							}

							if(column == null){
								column = {
									title: tgl,
									columns: []
								};
							}

							schemaFields[key] = {type: 'number'};
							column.columns.push(
								{
									field: key,
									title: key.substring(10,13),
									width: 50,
									filterable: false,
									template: "<div class='customClass'> #= (" + key + " == 0) ? '0.00' : kendo.toString(" + key + ", '0.00') # </div>",
								},
							);
						}
					}

					if(column != null){
						columns.push(column);
						column = null;
					}

					if(typeof o.dom.$grid.data('kendoGrid') != 'undefined'){
						o.dom.$grid.data('kendoGrid').destroy();
						o.dom.$grid.empty();
					}

					console.log(result);
					o.dom.$grid.kendoGrid({
						excel: {
							fileName: "Produksi " + o.data.Type + ".xlsx",
							allPages: true,
							filterable: true
						},
						dataSource: {
							transport: {
								read: function (options) {
									options.success(result);
								}
							},
							schema: {
								model: {
									fields: schemaFields
								}
							},
							pageSize: 20
						},
						scrollable: true,
						sortable: true,
						resizable: true,
						reorderable: true,
						filterable: {
							extra: false,
							operators: {
								string: {
									contains: "Contains",
									eq: "Equal to",
									neq: "Not equal to"
								}
							}
						},
						pageable: {
							refresh: true,
							input: true,
							numeric: true,
							pageSizes: true,
							buttonCount: 5
						},
						columns: columns,
						toolbar: $("#template_toolbar").html(),
						dataBound: function(e) {
							o.initAfter();

							var grid = this;
							if(o.data.Type == 'NPL') {
								grid.showColumn(0);
							} else {
								grid.hideColumn(0);
							}
						}
					});
				}).fail(function (jqXHR, textStatus, errorThrown) {
					swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
					options.success({ data: [] });
				});
			}
		},
		init: function () {
			var o = this;
			o.cacheDom();
			o.attachEvents();
			o.initElements();
		},
		initElements: function () {
			var o = this;
			o.dom.$btnLoad.click();
		},
		initAfter: function () {
			var o = this;
			o.dom.Type = $("#Type");
			o.dom.Prod_Date = $("#Prod_Date");
			o.dom.Line = $("#LineOrderCode");
			o.dom.UN = $("#UniqueNumber");

			o.dom.Type.kendoDropDownList({
				dataSource: [
					{ id: "PL", name: "PL"},
					{ id: "NPL", name: "Non PL"}
				],
				dataValueField: "id",
				dataTextField: "name",
				value: o.data.Type,
				change: function(){
					o.data.Type = this.value();
					o.dom.$grid.data('kendoGrid').dataSource.read();
					o.dom.$btnLoad.click();
				}
			});

			o.dom.Prod_Date.kendoDatePicker({
				format: 'dd/MM/yyyy',
				value: o.data.Prod_Date,
				change: function () {
					o.data.Prod_Date = this.value() != null ? this.value() : '';

					if(this.value()){
						o.dom.$grid.data('kendoGrid').dataSource.read();
						o.dom.$btnLoad.click();
					}
				}
			});

			o.dom.Line.kendoComboBox({
				dataValueField: "IdValue",
				dataTextField: "ViewValue",
				filter: "contains",
				value: o.data.Line,
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl" + 'DropDown/INQ',
								dataType: 'text',
								data: JSON.stringify({ Ftype: "LineOrder", Plant: "" })
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								options.success({ data: [] });
							});
						}
					}
				},
				change: function(){
					o.data.Line = this.value();

					if (this.value() && this.selectedIndex == -1) {
						this.text("");
						this.value(null);
					}

					o.dom.$grid.data('kendoGrid').dataSource.read();
					o.dom.$btnLoad.click();
				}
			});

			o.dom.UN.kendoComboBox({
				dataValueField: "IdValue",
				dataTextField: "ViewValue",
				filter: "contains",
				value: o.data.UN,
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl" + 'DropDown/INQ',
								dataType: 'text',
								data: JSON.stringify({ Ftype: "FinishGoods", Plant: "" })
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								options.success({ data: [] });
							});
						}
					}
				},
				change: function(){
					o.data.UN = this.value();

					if (this.value() && this.selectedIndex == -1) {
						this.text("");
						this.value(null);
					}

					o.dom.$grid.data('kendoGrid').dataSource.read();
					o.dom.$btnLoad.click();
				}
			});
		}
	};

	$(function () {
		AppD.init();
	});
</script>

<script type="text/x-kendo-template" id="template_toolbar">
	<span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- Produksi -&nbsp;&nbsp;</span>
	<div class="toolbar">
		<button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
			<i class="k-icon k-i-excel"></i>
		</button>
		&nbsp;&nbsp;
		<input type="text" id="Type" placeholder="Type" />
		&nbsp;&nbsp;
		<input type="date" id="Prod_Date" placeholder="Periode" />
		&nbsp;&nbsp;
		<input id="LineOrderCode" placeholder="Line" />
		&nbsp;&nbsp;
		<input type="date" id="UniqueNumber" placeholder="Unique No" />
	</div>
</script>
