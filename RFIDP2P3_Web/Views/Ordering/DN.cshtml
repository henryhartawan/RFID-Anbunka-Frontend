@{
	ViewData["Title"] = "DN";
	string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<div class="page-main">
	<div class="page-content padding-10">
		<div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
	</div>
</div>

<script>
	var AppD = {
		attachEvents: function () {
			var o = this;
			o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
			o.dom.$grid.on('click', '#btnSync', o.eventHandlers.onClickBtnSync.bind(o));
		},
		cacheDom: function () {
			var o = this;
			o.dom.$grid = $("#grid");
		},
		data: {
			Prod_Date: new Date(),
			Supplier_Code: ''
		},
		dom: {},
		eventHandlers: {
			onClickBtnExcel: function () {
				var o = this;
				o.dom.$grid.data('kendoGrid').saveAsExcel();
			},
			onClickBtnSync: function () {
				var o = this;

				if(o.data.Prod_Date != '' && o.data.Prod_Date != null) {
					swal.fire({
						title: 'Sync to EDN?',
						html: 'Periode: ' + kendo.toString(o.data.Prod_Date, 'yyyyMMdd') + '<br>Supplier: ' + o.data.Supplier_Code,
						icon: 'warning',
						showCancelButton: true,
						confirmButtonText: 'Yes'
					}).then((result) => {
						if (result.isConfirmed) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl" + 'DN/Sync',
								dataType: 'text',
								data: JSON.stringify({
									Periode: kendo.toString(o.data.Prod_Date, 'yyyyMMdd'),
									Supplier_Code: o.data.Supplier_Code,
									UserLogin: "@Context.Session.GetString("PIC_ID")"
								})
							}).done(function (data, textStatus, jqXHR) {
								if (data !== 'success') {
									swal.fire('', data, 'error');
									console.log(jqXHR);
									return;
								}
								swal.fire({ title: 'Success', text: 'Data synced', icon: 'success', timer: 2000, showConfirmButton: false });
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								console.log(jqXHR);
							}).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
								o.dom.$grid.data('kendoGrid').dataSource.read();
							});
						}
					});
				} else {
					swal.fire({ title: 'Warning', text: 'Please choose periode first', icon: 'warning'});
				}
			},
		},
		init: function () {
			var o = this;
			o.cacheDom();
			o.attachEvents();
			o.initElements();
		},
		initElements: function () {
			var o = this;

			o.dom.$grid.kendoGrid({
				excel: {
					fileName: "DN.xlsx",
					allPages: true,
					filterable: true
				},
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl"+'DN/INQ',
								dataType: 'text',
								data: JSON.stringify({
									Periode: kendo.toString(o.data.Prod_Date, 'yyyyMMdd'),
									Supplier_Code: o.data.Supplier_Code
								})
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									console.log(data);
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								console.log(jqXHR);
								options.success({ data: [] });
							});
						}
					},
					schema: {
						model: {
							fields: {
								Periode_ID: { type: "string" },
								PO_Year: { type: "string" },
								PO_Month: { type: "string" },
								PO_No: { type: "string" },
								Supplier_Code: { type: "string" },
								Part_No: { type: "string" },
								DN_No: { type: "string" },
								DN_Date: { type: "date" },
								DN_Seq: { type: "number" },
								Cycle_Issue: { type: "string" },
								Shop_Code: { type: "string" },
								DN_Schedule_Delivery_Date: { type: "date" },
								DN_Schedule_Seq: { type: "number" },
								DN_Qty: { type: "number" },
								Plant_Code: { type: "string" },
								Record_Status: { type: "string" },
								Part_Name: { type: "string" },
								Job_No: { type: "string" },
								Transporter: { type: "string" },
								Group_Route: { type: "string" },
								Part_Category: { type: "string" },
								Doc_Code: { type: "string" },
								Parking_No: { type: "string" },
								Total_Kanban: { type: "number" },
								LineOrderCode: { type: "string" },
								RackNumber: { type: "string" },
								Lane_No: { type: "number" },
								Create_Date: { type: "date" },
								Create_By: { type: "string" },
								DN_Status: { type: "string" },
								CycleIssueLP: { type: "string" }
							}
						}
					},
					pageSize: 20
				},
				scrollable: true,
				sortable: true,
				resizable: true,
				reorderable: true,
				filterable: {
					extra: false,
					operators: {
						string: {
							contains: "Contains",
							eq: "Equal to",
							neq: "Not equal to"
						}
					}
				},
				pageable: {
					refresh: true,
					input: true,
					numeric: true,
					pageSizes: true,
					buttonCount: 5
				},
				columns: [
				{
					field: "Periode_ID",
					title: "Periode",
					width: 100,
				},
				{
					field: "PO_Year",
					title: "PO Year",
					width: 80
				},
				{
					field: "PO_Month",
					title: "PO Month",
					width: 100
				},
				{
					field: "PO_No",
					title: "PO No",
					width: 100
				},
				{
					field: "Supplier_Code",
					title: "Supplier",
					width: 100
				},
				{
					field: "Part_No",
					title: "Part No",
					width: 100
				},
				{
					field: "DN_No",
					title: "DN No",
					width: 150
				},
				{
					field: "DN_Date",
					title: "DN Date",
					width: 100,
					template: "<div class='customClass'> #= (DN_Date == null) ? ' ' : kendo.toString(DN_Date, 'dd/MM/yyyy') # </div>",
				},
				{
					field: "DN_Seq",
					title: "DN Seq",
					width: 50
				},
				{
					field: "Cycle_Issue",
					title: "Cycle Issue",
					width: 100
				},
				{
					field: "Shop_Code",
					title: "Shop",
					width: 100,
					template: "<div class='customClass'> #= (Shop_Code == null) ? ' ' : kendo.toString(Shop_Code, '') # </div>",
				},
				{
					field: "DN_Schedule_Delivery_Date",
					title: "Delivery Date",
					width: 100,
					template: "<div class='customClass'> #= (DN_Schedule_Delivery_Date == null) ? ' ' : kendo.toString(DN_Schedule_Delivery_Date, 'dd/MM/yyyy') # </div>",
				},
				{
					field: "DN_Schedule_Seq",
					title: "Delivery Seq",
					width: 100
				},
				{
					field: "DN_Qty",
					title: "DN Qty",
					width: 100
				},
				{
					field: "Plant_Code",
					title: "Plant",
					width: 100
				},
				{
					field: "Record_Status",
					title: "Status",
					width: 100
				},
				{
					field: "Part_Name",
					title: "Part Name",
					width: 100,
					template: "<div class='customClass'> #= (Part_Name == null) ? ' ' : kendo.toString(Part_Name, '') # </div>",
				},
				{
					field: "Job_No",
					title: "Job No",
					width: 100
				},
				{
					field: "Transporter",
					title: "Transporter",
					width: 150,
					template: "<div class='customClass'> #= (Transporter == null) ? ' ' : kendo.toString(Transporter, '') # </div>",
				},
				{
					field: "Group_Route",
					title: "Group_Route",
					width: 100
				},
				{
					field: "Part_Category",
					title: "Part Category",
					width: 100,
					template: "<div class='customClass'> #= (Part_Category == null) ? ' ' : kendo.toString(Part_Category, '') # </div>",
				},
				{
					field: "Doc_Code",
					title: "Dock",
					width: 100
				},
				{
					field: "Parking_No",
					title: "Parking No",
					width: 100,
					template: "<div class='customClass'> #= (Parking_No == null) ? ' ' : kendo.toString(Parking_No, '') # </div>",
				},
				{
					field: "Total_Kanban",
					title: "Total Kanban",
					width: 100
				},
				{
					field: "LineOrderCode",
					title: "Line",
					width: 100
				},
				{
					field: "RackNumber",
					title: "Rack No.",
					width: 100
				},
				{
					field: "Lane_No",
					title: "Lane No.",
					width: 100
				},
				{
					field: "CycleIssueLP",
					title: "Cycle Issue LP",
					width: 100
				},
				{
					field: "Create_Date",
					title: "Create Date",
					width: 100,
					template: "<div class='customClass'> #= (Create_Date == null) ? ' ' : kendo.toString(Create_Date, 'dd/MM/yyyy HH:mm:ss') # </div>",
				},
				{
					field: "Create_By",
					title: "Create By",
					width: 100
				},
				{
					field: "DN_Status",
					title: "Status",
					width: 100,
					template: "<div class='customClass'> #= (DN_Status == null) ? ' ' : kendo.toString(DN_Status, '') # </div>",
				}],
				toolbar: $("#template_toolbar").html(),
				dataBound: function(e) {
					o.initAfter();
				}
			});
		},
		initAfter: function(){
			var o = this;
			if (o.initAfterCalled) return;
			o.initAfterCalled = true;
			o.dom.Prod_Date = $("#Prod_Date");
			o.dom.Supplier_Code = $("#Supplier_Code");

			o.dom.Prod_Date.kendoDatePicker({
				format: 'yyyyMMdd',
				value: o.data.Prod_Date,
				change: function () {
					o.data.Prod_Date = this.value() != null ? this.value() : '';

					if(this.value()){
						o.dom.$grid.data('kendoGrid').dataSource.read();
					}
				}
			});

			o.dom.Supplier_Code.kendoMultiSelect({
				dataValueField: "IdValue",
				dataTextField: "ViewValue",
				filter: "contains",
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl" + 'DropDown/INQ',
								dataType: 'text',
								data: JSON.stringify({ Ftype: "Supplier", Plant: "" })
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								options.success({ data: [] });
							});
						}
					}
				},
				value: o.data.Supplier_Code,
				change: function () {
					o.data.Supplier_Code = this.value() != null ? this.value().join('; ') : '';
					o.dom.$grid.data('kendoGrid').dataSource.read();
				},
				tagMode: "none",
				clearButton: false
			});
		}
	};

	$(function () {
		AppD.init();
	});
</script>

<script type="text/x-kendo-template" id="template_toolbar">
	<span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- DN -&nbsp;&nbsp;</span>
	<div class="toolbar">
	@if (Context.Session.GetString("edit_DN") == "True")
	{
		<button data-toggle="tooltip" title="Sync to EDN" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnSync">
			<i class="fa fa-refresh"></i>
		</button>
	}
		<button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
			<i class="k-icon k-i-excel"></i>
		</button>
		&nbsp;&nbsp;
		<input type="date" id="Prod_Date" placeholder="Periode" />
		&nbsp;&nbsp;
		<input type="text" id="Supplier_Code" placeholder="Supplier" style="width:200px;" />
	</div>
</script>
