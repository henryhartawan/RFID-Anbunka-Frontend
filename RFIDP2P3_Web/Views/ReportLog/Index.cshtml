@{
	ViewData["Title"] = "Report Area";
	string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<div class="page-main">
	<div class="page-content padding-10">
		<div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
	</div>
</div>

<script>
	var AppD = {
		attachEvents: function () {
			var o = this;
			o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
			o.dom.$grid.on('click', '#btnSearch', o.eventHandlers.onClickBtnSearch.bind(o));

			o.dom.$grid.on('click', '.btnSAP', o.eventHandlers.onClickBtnSAP.bind(o));
			o.dom.$grid.on('click', '.btnAnbunka', o.eventHandlers.onClickBtnAnbunka.bind(o));
		},
		cacheDom: function () {
			var o = this;
			o.dom.$grid = $("#grid");
		},
		data: {
			From: '',
			To: ''
		},
		dom: {},
		eventHandlers: {
			onClickBtnExcel: function () {
				var o = this;
				o.dom.$grid.data('kendoGrid').saveAsExcel();
			},
			onClickBtnSearch: function () {
				var o = this;
				o.dom.$grid.data('kendoGrid').dataSource.read();
			},
			onClickBtnSAP: function (e) {
				var o = this;
				var di = o.dom.$grid.data('kendoGrid').dataItem($(e.target).closest('tr'));

				var pattern = /(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/;
				var dt = new Date(di.ProcessDate.replace(pattern, '$3-$2-$1 $4:$5:$6'));

				swal.fire({
					title: "Resync SAP Process?",
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							method: 'post',
							headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
							url: "@myurl" + 'ReportLog/Resync',
							dataType: 'text',
							data: JSON.stringify({
								ID: di.ID,
								ScanType: di.ScanType,
								ProcessDate: kendo.toString(dt, 'yyyy-MM-dd HH:mm:ss'),
								RFIDNo: di.RFIDNo,
								Type: 'SAP',
								UserLogin: "@Context.Session.GetString("PIC_ID")"
							})
						}).done(function (data, textStatus, jqXHR) {
							if (data !== 'success') {
								swal.fire('Error', data, 'error');
								return;
							}
							swal.fire({ title: 'Success', text: 'Data saved', icon: 'success', timer: 2000, showConfirmButton: false });
						}).fail(function (jqXHR, textStatus, errorThrown) {
							swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
						}).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
							o.dom.$grid.data('kendoGrid').dataSource.read();
						});
					}
				});
			},
			onClickBtnAnbunka: function (e) {
				var o = this;
				var di = o.dom.$grid.data('kendoGrid').dataItem($(e.target).closest('tr'));

				var pattern = /(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/;
				var dt = new Date(di.ProcessDate.replace(pattern, '$3-$2-$1 $4:$5:$6'));

				swal.fire({
					title: "Resync Anbunka Process?",
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes'
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							method: 'post',
							headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
							url: "@myurl" + 'ReportLog/Resync',
							dataType: 'text',
							data: JSON.stringify({
								ID: di.ID,
								ScanType: di.ScanType,
								ProcessDate: kendo.toString(dt, 'yyyy-MM-dd HH:mm:ss'),
								RFIDNo: di.RFIDNo,
								Type: 'Anbunka',
								UserLogin: "@Context.Session.GetString("PIC_ID")"
							})
						}).done(function (data, textStatus, jqXHR) {
							if (data !== 'success') {
								swal.fire('Error', data, 'error');
								return;
							}
							swal.fire({ title: 'Success', text: 'Data saved', icon: 'success', timer: 2000, showConfirmButton: false });
						}).fail(function (jqXHR, textStatus, errorThrown) {
							swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
						}).always(function (data_or_jqXHR, textStatus, jqXHR_or_errorThrown) {
							o.dom.$grid.data('kendoGrid').dataSource.read();
						});
					}
				});
			},
		},
		init: function () {
			var o = this;
			o.cacheDom();
			o.attachEvents();
			o.initElements();
		},
		initElements: function () {
			var o = this;

			o.dom.$grid.kendoGrid({
				excel: {
					fileName: "Report Log per Area.xlsx",
					allPages: true,
					filterable: true
				},
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl" + 'ReportLog/INQ',
								dataType: 'text',
								data: JSON.stringify({
									From: o.data.From,
									To: o.data.To
								})
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									console.log(data);
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								console.log(jqXHR);
								options.success({ data: [] });
							});
						}
					},
					schema: {
						model: {
							id: "ID",
							fields: {
								ID: { type: "string" },
								ScanType: { type: "string" },
								ProcessArea: { type: "string" },
								ProcessDate: { type: "string" },
								PalletType: { type: "string" },
								RFIDNo: { type: "string" },
								LDK_No: { type: "string" },
								PartNumber: { type: "string" },
								PartDescription: { type: "string" },
								Qty: { type: "string" },
								KanbanNo: { type: "string" },
								RFIDStatus: { type: "string" },
								RFIDErrMsg: { type: "string" },
								SAPStatus: { type: "string" },
								SAPDocNo: { type: "string" },
								SAPErrMsg: { type: "string" },
								AnbunkaStatus: { type: "string" },
								AnbunkaDocNo: { type: "string" },
								AnbunkaErrMsg: { type: "string" },
								SAPButton: { type: "string" },
								AnbunkaButton: { type: "string" },
								UserLogin: { type: "string" },
								BuildingName: { type: "string" },
								Cycle: { type: "string" },
								HeaderTxt: { type: "string" }
							}
						}
					},
					pageSize: 20
				},
				scrollable: true,
				sortable: true,
				resizable: true,
				reorderable: true,
				filterable: {
					extra: false,
					operators: {
						string: {
							contains: "Contains",
							eq: "Equal to",
							neq: "Not equal to"
						}
					}
				},
				pageable: {
					refresh: true,
					input: true,
					numeric: true,
					pageSizes: true,
					buttonCount: 5
				},
				columns: [
				@if (Context.Session.GetString("edit_ReportLog") == "True")
				{
					<text>
					{
						width: 50,
						title: "SAP",
						command: [{
							name: "SAP",
							text: "<i class='fa fa-refresh btnSAP' style='font-size:18px;color:blue;'></i>"
						}]
					},
					</text>
				}
				@if (Context.Session.GetString("edit_ReportLog") == "True")
				{
					<text>
					{
						width: 50,
						title: "Anbunka",
						command: [{
							name: "Anbunka",
							text: "<i class='fa fa-refresh btnAnbunka' style='font-size:18px;color:green;'></i>"
						}]
					},
					</text>
				}
				{
					field: "ID",
					hidden: true
				},
				{
					field: "ScanType",
					hidden: true
				},
				{
					field: "ProcessArea",
					title: "Process Area",
					width: 100
				},
				{
					field: "ProcessDate",
					title: "Process Date",
					width: 150
				},
				{
					field: "BuildingName",
					title: "Gedung",
					width: 100
				},
				{
					field: "PalletType",
					title: "RFID Type",
					width: 150
				},
				{
					field: "RFIDNo",
					title: "Pallet No",
					width: 150,
					template: "<div class='customClass'> #= (RFIDNo == null) ? ' ' : kendo.toString(RFIDNo, '') # </div>",
				},
				{
					title: "No. LDK",
					field: "LDK_No",
					template: function (dataItem) {
						var str = dataItem.LDK_No;
						var res = str.replace(/\;/g, '<br/>');
						return res;
					},
					width: 150
				},
				{
					title: "Part",
					columns: [
					{
						field: "PartNumber",
						title: "No",
						width: 100
					},
					{
						field: "PartDescription",
						title: "Desc",
						width: 200,
						template: "<div class='customClass'> #= (PartDescription == null) ? ' ' : kendo.toString(PartDescription, '') # </div>",
					},
					{
						field: "Qty",
						title: "Qty",
						width: 50
					}]
				},
				{
					field: "KanbanNo",
					title: "Kanban No",
					width: 250
				},
				{
					field: "Cycle",
					title: "Cycle",
					width: 50
				},
				{
					field: "UserLogin",
					title: "User Process",
					width: 150
				},
				{
					title: "RFID",
					columns: [
					{
						field: "RFIDStatus",
						title: "Status",
						width: 150
					},
					{
						field: "RFIDErrMsg",
						title: "Error Msg",
						width: 250,
						template: "<div class='customClass'> #= (RFIDErrMsg == null) ? ' ' : kendo.toString(RFIDErrMsg, '') # </div>",
					}]
				},
				{
					title: "SAP",
					columns: [
					{
						field: "SAPStatus",
						title: "Status",
						width: 80
					},
					{
						field: "HeaderTxt",
						title: "HeaderTxt",
						width: 150
					},
					{
						field: "SAPDocNo",
						title: "Doc No",
						width: 80
					},
					{
						field: "SAPErrMsg",
						title: "Error Msg",
						width: 250,
						template: "<div class='customClass'> #= (SAPErrMsg == null) ? ' ' : kendo.toString(SAPErrMsg, '') # </div>",
					}]
				},
				{
					title: "Anbunka",
					columns: [
					{
						field: "AnbunkaStatus",
						title: "Status",
						width: 80
					},
					{
						field: "AnbunkaDocNo",
						title: "Doc No",
						width: 80
					},
					{
						field: "AnbunkaErrMsg",
						title: "Error Msg",
						width: 250,
						template: "<div class='customClass'> #= (AnbunkaErrMsg == null) ? ' ' : kendo.toString(AnbunkaErrMsg, '') # </div>",
					}]
				}],
				toolbar: $("#template_toolbar").html(),
				dataBound: function () {
					o.initAfter();

					var grid = this;
					grid.tbody.find("tr[role='row']").each(function () {
						var model = grid.dataItem(this);
						if (model.SAPButton == 'O') {
							$(this).find(".k-grid-SAP").show();
						} else {
							$(this).find(".k-grid-SAP").hide();
						}

						if (model.AnbunkaButton == 'O') {
							$(this).find(".k-grid-Anbunka").show();
						} else {
							$(this).find(".k-grid-Anbunka").hide();
						}
					});
				}
			});
		},
		initAfter: function () {
			var o = this;
			if (o.initAfterCalled) return;
			o.initAfterCalled = true;

			o.dom.From = $("#From");
			o.dom.To = $("#To");

			o.dom.From.kendoDatePicker({
				format: 'dd MMM yyyy',
				value: o.data.From,
				max: kendo.toString(new Date(),'yyyy-MM-dd'),
				change: function () {
					o.data.From = this.value() != null ? kendo.toString(this.value(), 'yyyy-MM-dd') : '';
					if (this.value() != null) o.dom.To.data('kendoDatePicker').min(o.data.From);
				}
			});

			o.dom.To.kendoDatePicker({
				format: 'dd MMM yyyy',
				value: o.data.To,
				max: kendo.toString(new Date(), 'yyyy-MM-dd'),
				change: function () {
					o.data.To = this.value() != null ? kendo.toString(this.value(), 'yyyy-MM-dd') : '';
					if (this.value() != null) o.dom.From.data('kendoDatePicker').max(o.data.To);
				}
			});
		}
	};

	$(function () {
		AppD.init();
	});
</script>

<script type="text/x-kendo-template" id="template_toolbar">
	<span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- Report Log per Area -&nbsp;&nbsp;</span>
	<div class="toolbar">
		<button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
			<i class="k-icon k-i-excel"></i>
		</button>
		&nbsp;&nbsp;
		<input type="date" id="From" placeholder="From" />&nbsp;
		<input type="date" id="To" placeholder="To" />&nbsp;
		<button data-toggle="tooltip" title="Search" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnSearch">
			<i class="fa fa-search"></i>
		</button>
	</div>
</script>
