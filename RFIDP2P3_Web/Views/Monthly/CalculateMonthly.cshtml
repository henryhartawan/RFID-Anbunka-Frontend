@{
	ViewData["Title"] = "Calculate Monthly";
	string myurl = new ConfigurationBuilder().AddJsonFile("appsettings.json").Build().GetSection("Path:URL").Value;
}

<div class="page-main">
	<div class="page-content padding-5">
		<div id="grid" style="margin-top:5px; margin-bottom:5px;"></div>
	</div>
</div>

<script>
	var AppD = {
		attachEvents: function () {
			var o = this;
			o.dom.$grid.on('click', '#btnExcel', o.eventHandlers.onClickBtnExcel.bind(o));
			o.dom.$grid.on('click', '#btnCalc', o.eventHandlers.onClickBtnCalc.bind(o));
			o.dom.$grid.on('click', '#btnReset', o.eventHandlers.onClickBtnReset.bind(o));
		},
		cacheDom: function () {
			var o = this;
			o.dom.$grid = $("#grid");
		},
		data: {
			Type: '3',
			Periode: kendo.toString(new Date(), "yyyyMM")
		},
		dom: {},
		eventHandlers: {
			onClickBtnExcel: function () {
				var o = this;
				o.dom.$grid.data('kendoGrid').saveAsExcel();
			},
			onClickBtnReset: function () {
				var o = this;

				swal.fire({
					title: 'Reset?',
					html: '<input id="Periode" style="width:75%;" Placeholder="Periode">',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes',
					didOpen: () => {
						$("#Periode").kendoDatePicker({
							format: "yyyyMM",
							value: o.data.Periode,
							change: function (e) {
								o.data.Periode = kendo.toString(this.value(), "yyyyMM");
							},
							depth: "year",
							start: "year"
						}).data("kendoDatePicker");
					},
					preConfirm: () => {
						var periode = $("#Periode").data('kendoDatePicker').value();

						if(periode === '' || periode == null) {
							swal.showValidationMessage('Periode harus diisi');
							return false;
						}

						return true;
					},
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							method: 'post',
							headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
							url: "@myurl"+'CalculateMonthly/Reset',
							dataType: 'text',
							data: JSON.stringify({
								Periode_ID: o.data.Periode,
								User_Login: "@Context.Session.GetString("PIC_ID")"
							}),
							beforeSend: function() {
								swal.fire({
									html: '<h5>On progress reset please wait...</h5>',
									showConfirmButton: false,
									allowOutsideClick: false,
									closeOnClickOutside: false,
									onRender: function() {
										$('.swal2-content').prepend(sweet_loader);
									}
								});
							},
						}).done(function( data, textStatus, jqXHR ) {
							if(data !== 'success'){
								swal.fire('', data, 'error');
								console.log(jqXHR);
								return;
							}
							swal.fire({ title: 'Success', icon: 'success', timer: 2000, showConfirmButton: false });
						}).fail(function( jqXHR, textStatus, errorThrown ) {
							swal.fire('Error', errorThrown + (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
							console.log(jqXHR);
						}).always(function( data_or_jqXHR, textStatus, jqXHR_or_errorThrown ){
							o.dom.$grid.data('kendoGrid').dataSource.read();
						});
					}
				});
			},
			onClickBtnCalc: function () {
				var o = this;

				swal.fire({
					title: 'Calculate?',
					html: '<input id="Groups" style="width:75%;" Placeholder="Group"><br/><br/><input id="Periode" style="width:75%;" Placeholder="Periode">',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Yes',
					didOpen: () => {
						$("#Groups").kendoDropDownList({
							value: o.data.Type,
							dataTextField: "text",
							dataValueField: "value",
							dataSource: [
								{text: "Volume Metric", value: "3"}
							],
							change: function (e) {
								o.data.Type = this.value();
							}
						}).data("kendoDropDownList");

						$("#Periode").kendoDatePicker({
							format: "yyyyMM",
							value: o.data.Periode,
							change: function (e) {
								o.data.Periode = kendo.toString(this.value(), "yyyyMM");
							},
							depth: "year",
							start: "year"
						}).data("kendoDatePicker");
					},
					preConfirm: () => {
						var periode = $("#Periode").data('kendoDatePicker').value();

						if(periode === '' || periode == null) {
							swal.showValidationMessage('Periode harus diisi');
							return false;
						}

						return true;
					},
				}).then((result) => {
					if (result.isConfirmed) {
						$.ajax({
							method: 'post',
							headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
							url: "@myurl"+'CalculateMonthly/Calc',
							dataType: 'text',
							data: JSON.stringify({
								Type: o.data.Type,
								Periode_ID: o.data.Periode,
								User_Login: "@Context.Session.GetString("PIC_ID")"
							}),
							beforeSend: function() {
								swal.fire({
									html: '<h5>Calculating please wait...</h5>',
									showConfirmButton: false,
									allowOutsideClick: false,
									closeOnClickOutside: false,
									onRender: function() {
										$('.swal2-content').prepend(sweet_loader);
									}
								});
							},
						}).done(function( data, textStatus, jqXHR ) {
							if(data !== 'success'){
								swal.fire('', data, 'error');
								console.log(jqXHR);
								return;
							}
							swal.fire({ title: 'Success', icon: 'success', timer: 2000, showConfirmButton: false });
						}).fail(function( jqXHR, textStatus, errorThrown ) {
							swal.fire('Error', errorThrown + (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
							console.log(jqXHR);
						}).always(function( data_or_jqXHR, textStatus, jqXHR_or_errorThrown ){
							o.dom.$grid.data('kendoGrid').dataSource.read();
						});
					}
				});
			},
		},
		init: function () {
			var o = this;
			o.cacheDom();
			o.attachEvents();
			o.initElements();
		},
		initElements: function () {
			var o = this;

			o.dom.$grid.kendoGrid({
				excel: {
					fileName: "Calculate Monthly.xlsx",
					allPages: true,
					filterable: true
				},
				dataSource: {
					transport: {
						read: function (options) {
							$.ajax({
								method: 'post',
								headers: { 'Content-Type': 'application/json', 'XApiKey': 'pgH7QzFHJx4w46fI~5Uzi4RvtTwlEXp' },
								url: "@myurl"+'CalculateMonthly/INQ',
								dataType: 'text',
								data: {}
							}).done(function (data, textStatus, jqXHR) {
								try {
									var result = JSON.parse(data);
								}
								catch (e) {
									swal.fire('Error', 'Error loading grid', 'error');
									options.success({ data: [] });
									return;
								}
								options.success(result);
							}).fail(function (jqXHR, textStatus, errorThrown) {
								swal.fire('Error', (jqXHR.responseText !== '' ? ': ' + jqXHR.responseText : ''), 'error');
								options.success({ data: [] });
							});
						}
					},
					schema: {
						model: {
							fields: {
								Calc_Groups: { type: "string" },
								Calc_Status: { type: "string" },
								Error_Message: { type: "string" },
								Periode_ID: { type: "string" },
								Calc_Date: { type: "date" },
								Calc_By: { type: "string" }
							}
						}
					},
					pageSize: 20
				},
				scrollable: true,
				sortable: true,
				resizable: true,
				reorderable: true,
				filterable: {
					extra: false,
					operators: {
						string: {
							contains: "Contains",
							eq: "Equal to",
							neq: "Not equal to"
						}
					}
				},
				pageable: {
					refresh: true,
					input: true,
					numeric: true,
					pageSizes: true,
					buttonCount: 5
				},
				columns: [
				{
					field: "Periode_ID",
					title: "Periode",
					width: 100
				},
				{
					field: "Calc_Groups",
					title: "Group",
					width: 150
				},
				{
					field: "Calc_Status",
					title: "Status",
					width: 100,
				},
				{
					field: "Error_Message",
					title: "Error Message",
					width: 200,
					template: "<div class='customClass'> #= (Error_Message == null) ? ' ' : kendo.toString(Error_Message, '') # </div>",
				},
				{
					title: "Calc",
					columns: [
					{
						field: "Calc_By",
						title: "User",
						width: 100
					},
					{
						field: "Calc_Date",
						title: "Date",
						width: 150,
						template: "<div class='customClass'> #= (Calc_Date == null) ? ' ' : kendo.toString(Calc_Date, 'dd/MM/yyyy HH:mm:ss') # </div>",
					}]
				}],
				toolbar: $("#template_toolbar").html(),
				dataBound: function(e) {
					var rows = this.tbody.find("tr");
					rows.each(function() {
						var dataItem = e.sender.dataItem(this);
						if (dataItem.Calc_Status === "Error") {
							$(this).css("background-color", "#ff9999");
						}
					});
				}
			});
		}
	};

	$(function () {
		AppD.init();
	});
</script>

<script type="text/x-kendo-template" id="template_toolbar">
	<span class="k-pager-refresh" style="font-weight: bold">&nbsp;&nbsp;- Calculate -&nbsp;&nbsp;</span>
	<div class="toolbar">
	@if (Context.Session.GetString("add_CalculateMonthly") == "True")
	{
		<button data-toggle="tooltip" title="Calculate" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnCalc">
			<i class="fa fa-calculator"></i>
		</button>
	}
	@if (Context.Session.GetString("del_CalculateMonthly") == "True")
	{
		<button data-toggle="tooltip" title="Reset" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnReset">
			<i class="fa fa-trash"></i>
		</button>
	}
		<button data-toggle="tooltip" title="Save as Excel" type="button" class="btn ink-reaction btn-floating-action btn-xs btn-warning" id="btnExcel">
			<i class="k-icon k-i-excel"></i>
		</button>
	</div>
</script>
